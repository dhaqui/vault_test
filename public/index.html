
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayPal Vault Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 24px;
    }
    .container { max-width: 720px; margin: 0 auto; }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,.08);
    }
    h1 { margin-bottom: 6px; }
    h2 { font-size: 16px; margin-bottom: 14px; color: #333; }
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
      vertical-align: middle;
    }
    .badge-new      { background: #e8f5e9; color: #2e7d32; }
    .badge-returning { background: #e3f2fd; color: #1565c0; }
    .info-box {
      background: #f5f7fa;
      border-left: 4px solid #667eea;
      border-radius: 6px;
      padding: 12px 14px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .info-box .label { font-weight: bold; color: #444; margin-bottom: 4px; }
    .info-box .value { font-family: monospace; color: #555; word-break: break-all; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
    .alert-success { background: #d4edda; color: #155724; }
    .alert-info    { background: #d1ecf1; color: #0c5460; }
    .alert-danger  { background: #f8d7da; color: #721c24; }
    .debug-log {
      background: #0b1220;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 320px;
      overflow-y: auto;
      line-height: 1.7;
    }
    .debug-log .ts      { color: #608b4e; }
    .debug-log .success { color: #4ec9b0; }
    .debug-log .error   { color: #f48771; }
    .debug-log .info    { color: #9cdcfe; }
    .debug-log .vault   { color: #dcdcaa; font-weight: bold; }
    #paypal-button-container { min-height: 50px; }
    .clear-btn {
      display: block;
      margin: 8px auto 0;
      padding: 10px 28px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .clear-btn:hover { background: #c62828; }
    pre {
      background: #f5f7fa;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="card">
    <h1>ğŸ’³ PayPal Vault Demo</h1>
    <p style="color:#666;font-size:14px;margin-top:6px">
      åˆå›ï¼šPayPalã§æ±ºæ¸ˆ â†’ Vaultä¿å­˜<br>
      2å›ç›®ä»¥é™ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã«ä¿å­˜æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸçŠ¶æ…‹ã§é–‹ãï¼ˆå…¬å¼ Returning Payer ãƒ•ãƒ­ãƒ¼ï¼‰
    </p>
  </div>

  <!-- ä¿å­˜æ¸ˆã¿æƒ…å ± -->
  <div id="saved-section" style="display:none">
    <div class="card">
      <h2>ğŸ‘¤ ä¿å­˜æ¸ˆã¿Vaultæƒ…å ±</h2>
      <div id="saved-content"></div>
    </div>
  </div>

  <!-- ãƒ­ã‚° -->
  <div class="card">
    <h2>ğŸ“‹ ãƒ­ã‚°</h2>
    <div class="debug-log" id="log-area">
      <span class="info">åˆæœŸåŒ–ä¸­...</span>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div id="status"></div>

  <!-- PayPal ãƒœã‚¿ãƒ³ -->
  <div class="card">
    <h2 id="btn-title">PayPalã§æ”¯æ‰•ã†</h2>
    <p id="btn-desc" style="font-size:13px;color:#666;margin-bottom:14px"></p>
    <div id="paypal-button-container"></div>
  </div>

  <!-- Capture ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´° -->
  <div id="result-section" style="display:none">
    <div class="card">
      <h2>ğŸ“„ Captureãƒ¬ã‚¹ãƒãƒ³ã‚¹</h2>
      <pre id="result-json"></pre>
    </div>
  </div>

  <button class="clear-btn" onclick="clearData()">ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>

</div>
<script>
(async () => {

  // ===== State =====
  let customerId = localStorage.getItem('paypal_customer_id') || null;
  let vaultId    = localStorage.getItem('paypal_vault_id')    || null;

  // ===== Logging =====
  function log(msg, type = 'info') {
    const el = document.getElementById('log-area');
    const ts = new Date().toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit', second:'2-digit', fractionalSecondDigits:2 });
    const div = document.createElement('div');
    div.innerHTML = `<span class="ts">[${ts}]</span> <span class="${type}">${msg}</span>`;
    el.insertBefore(div, el.firstChild);
  }

  // ===== ä¿å­˜æ¸ˆã¿æƒ…å ±è¡¨ç¤º =====
  function renderSaved() {
    if (!customerId && !vaultId) return;
    document.getElementById('saved-section').style.display = 'block';
    let html = '';
    if (vaultId) {
      html += `<div class="info-box" style="border-left-color:#0070ba">
        <div class="label">ğŸ” Vault IDï¼ˆPayment Tokenï¼‰</div>
        <div class="value">${vaultId}</div>
      </div>`;
    }
    if (customerId) {
      html += `<div class="info-box">
        <div class="label">Customer ID</div>
        <div class="value">${customerId}</div>
      </div>`;
    }
    document.getElementById('saved-content').innerHTML = html;
  }

  // ===== UI æ›´æ–° =====
  function updateButtonArea() {
    if (customerId) {
      document.getElementById('btn-title').innerHTML =
        'ğŸ”„ PayPalã§æ”¯æ‰•ã† <span class="badge badge-returning">Returning Payer</span>';
      document.getElementById('btn-desc').textContent =
        'ä¿å­˜æ¸ˆã¿ã®PayPalã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
    } else {
      document.getElementById('btn-title').innerHTML =
        'ğŸ†• PayPalã§æ”¯æ‰•ã† <span class="badge badge-new">åˆå›</span>';
      document.getElementById('btn-desc').textContent =
        'PayPalã§æ”¯æ‰•ã†ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä¿å­˜ã•ã‚Œã€æ¬¡å›ã‹ã‚‰ç°¡å˜ã«æ”¯æ‰•ãˆã¾ã™ã€‚';
    }
  }

  function showStatus(msg, type = 'info') {
    document.getElementById('status').innerHTML =
      `<div class="alert alert-${type}">${msg}</div>`;
  }

  // ===== Payment Tokens ç¢ºèª =====
  async function checkPaymentTokens() {
    if (!customerId) return;
    try {
      log('Payment Tokens ç¢ºèªä¸­...');
      const resp = await fetch(`/api/payment-tokens/${encodeURIComponent(customerId)}`);
      const data = await resp.json();
      if (data.payment_tokens?.length > 0) {
        vaultId = data.payment_tokens[0].id;
        localStorage.setItem('paypal_vault_id', vaultId);
        log(`âœ“ Vaultæ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª: ${vaultId}`, 'vault');
        renderSaved();
      } else {
        log('Vaultæ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ãªã—', 'info');
      }
    } catch (e) {
      log(`Payment Tokens ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
    }
  }

  // ===== SDK èª­ã¿è¾¼ã¿ =====
  async function loadSDK() {
    log('SDK åˆæœŸåŒ–é–‹å§‹');

    const cfg = await (await fetch('/api/config')).json();

    // Returning Payer ã®å ´åˆã¯ target_customer_id ã‚’æ¸¡ã—ã¦ id_token ã‚’å–å¾—
    // â†’ SDK ãŒä¿å­˜æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã—ã¦ãã‚Œã‚‹
    const tokenUrl = customerId
      ? `/api/generate-client-token?customer_id=${encodeURIComponent(customerId)}`
      : '/api/generate-client-token';

    const { id_token } = await (await fetch(tokenUrl)).json();
    log(customerId ? `Returning Payer ç”¨ id_token å–å¾—` : 'æ–°è¦ Payer ç”¨ id_token å–å¾—', 'vault');

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      // vault=true ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ SDK ãŒ Vault å¯¾å¿œãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã™ã‚‹
      script.src = `https://www.paypal.com/sdk/js?client-id=${cfg.clientId}&vault=true&intent=capture&locale=ja_JP&currency=JPY`;
      script.setAttribute('data-user-id-token', id_token);
      script.onload  = () => { log('âœ“ PayPal SDK èª­ã¿è¾¼ã¿å®Œäº†', 'success'); resolve(); };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // ===== PayPal ãƒœã‚¿ãƒ³åˆæœŸåŒ– =====
  function initButtons() {
    log('ãƒœã‚¿ãƒ³åˆæœŸåŒ–ä¸­...');

    paypal.Buttons({
      style: { layout: 'vertical', label: 'paypal' },

      // Returning Payer ã®å ´åˆ: customer_id ã‚’æ¸¡ã™ã“ã¨ã§
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«ä¿å­˜æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé¸æŠæ¸ˆã¿ã§è¡¨ç¤ºã•ã‚Œã‚‹
      vault: customerId ? { customer_id: customerId } : undefined,

      // Order ä½œæˆ
      // åˆå›ãƒ»2å›ç›®ã¨ã‚‚ã«åŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€‚
      // customerId ãŒã‚ã‚‹å ´åˆã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ vault.customer_id ã«ç´ä»˜ã‘ã‚‹
      createOrder: async () => {
        log('Order ä½œæˆä¸­...');
        showStatus('æ³¨æ–‡ã‚’ä½œæˆä¸­...');
        const resp = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerId })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || JSON.stringify(data));
        log(`âœ“ Order ä½œæˆ: ${data.id}`, 'success');
        return data.id;
      },

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ PayPal ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æ‰¿èªå¾Œ
      onApprove: async (data) => {
        log('Capture é–‹å§‹...');
        showStatus('æ±ºæ¸ˆå‡¦ç†ä¸­...');
        const resp    = await fetch(`/api/orders/${data.orderID}/capture`, { method: 'POST' });
        const capture = await resp.json();
        if (!resp.ok) throw new Error(capture.error || JSON.stringify(capture));

        log('âœ“ Capture å®Œäº†', 'success');

        // Vault æƒ…å ±ã‚’ä¿å­˜
        const vaultInfo    = capture.payment_source?.paypal?.attributes?.vault;
        const paypalSource = capture.payment_source?.paypal;

        log('='.repeat(40), 'vault');
        log('ğŸ” Vault ä¿å­˜æƒ…å ±', 'vault');

        if (vaultInfo) {
          log(`Vault ID: ${vaultInfo.id}`, 'vault');
          log(`Vault Status: ${vaultInfo.status}`, 'vault');
          log(`Customer ID: ${vaultInfo.customer?.id}`, 'vault');
        }
        if (paypalSource) {
          log(`Email: ${paypalSource.email_address}`, 'info');
          log(`Account ID: ${paypalSource.account_id}`, 'info');
        }
        log('='.repeat(40), 'vault');

        if (vaultInfo?.id) {
          vaultId = vaultInfo.id;
          localStorage.setItem('paypal_vault_id', vaultId);
        }
        if (vaultInfo?.customer?.id) {
          customerId = vaultInfo.customer.id;
          localStorage.setItem('paypal_customer_id', customerId);
        }

        renderSaved();
        showStatus('âœ… æ±ºæ¸ˆå®Œäº†ï¼3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...', 'success');

        // Capture ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
        document.getElementById('result-section').style.display = 'block';
        document.getElementById('result-json').textContent = JSON.stringify(capture, null, 2);

        setTimeout(() => location.reload(), 3000);
      },

      onCancel: () => {
        log('æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        showStatus('æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      },

      onError: (err) => {
        log(`ã‚¨ãƒ©ãƒ¼: ${err?.message || JSON.stringify(err)}`, 'error');
        showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (err?.message || err), 'danger');
      }

    }).render('#paypal-button-container')
      .then(() => log('âœ“ PayPal ãƒœã‚¿ãƒ³è¡¨ç¤ºå®Œäº†', 'success'));
  }

  function clearData() {
    if (!confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
    localStorage.clear();
    location.reload();
  }

  // ===== åˆæœŸåŒ– =====
  log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

  if (customerId || vaultId) {
    log('--- ä¿å­˜æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º ---', 'vault');
    if (customerId) log(`Customer ID: ${customerId}`, 'vault');
    if (vaultId)    log(`Vault ID: ${vaultId}`, 'vault');
    renderSaved();
  }

  await checkPaymentTokens();
  updateButtonArea();

  try {
    await loadSDK();
    initButtons();
  } catch (e) {
    log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
    showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + e.message, 'danger');
  }

})();
</script>
</body>
</html>
