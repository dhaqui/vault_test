<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayPal Vault â€” Returning + One-click (robust)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;background:#f6f8fb}
    .card{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
    input,button{padding:8px;border-radius:6px;border:1px solid #ccc}
    button{cursor:pointer}
    .primary{background:#0070ba;color:#fff;border:none;padding:10px;border-radius:6px}
    pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h1>PayPal Vault â€” Returning + One-click (robust)</h1>
    <p>VaultãŒã‚ã‚‹å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãšã‚µãƒ¼ãƒã§ Createâ†’Capture ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œã—ã¾ã™ã€‚</p>

    <div>
      <button id="clearStorage" class="muted">LocalStorage ã‚¯ãƒªã‚¢</button>
    </div>
    <div id="savedInfo" style="margin-top:12px"></div>
    <div id="paypal-button-container" style="margin-top:12px; min-height:120px"></div>
    <div style="margin-top:12px">
      <button id="oneclickDirect" class="primary">ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ±ºæ¸ˆï¼ˆVaultãŒã‚ã‚‹å ´åˆï¼‰</button>
    </div>

    <h3 style="margin-top:20px">ãƒ­ã‚°</h3>
    <pre id="log">starting...</pre>
  </div>

<script>
(async function(){
  const logEl = document.getElementById('log');
  function log(...args){ logEl.textContent = (new Date()).toLocaleTimeString() + ' ' + args.join(' ') + '\n' + logEl.textContent; }

  // load saved
  let customerId = localStorage.getItem('paypal_customer_id') || null;
  let vaultId = localStorage.getItem('paypal_vault_id') || null;
  let payerId = localStorage.getItem('paypal_payer_id') || null;
  let accountId = localStorage.getItem('paypal_account_id') || null;

  function renderSavedInfo(){
    const cont = document.getElementById('savedInfo');
    cont.innerHTML = '';
    if (vaultId) cont.innerHTML += `<div>ğŸ” vaultId: <code>${vaultId}</code></div>`;
    if (customerId) cont.innerHTML += `<div>ğŸ‘¤ customerId: <code>${customerId}</code></div>`;
    if (!vaultId && !customerId) cont.innerHTML = '<div>ä¿å­˜ãªã—</div>';
  }
  renderSavedInfo();

  document.getElementById('clearStorage').onclick = () => {
    localStorage.clear();
    customerId = vaultId = payerId = accountId = null;
    renderSavedInfo();
    log('LocalStorage cleared');
  };

  // config + id_token
  const cfg = (await (await fetch('/api/config')).json());
  let tokenUrl = '/api/generate-client-token';
  if (customerId) tokenUrl += `?customer_id=${encodeURIComponent(customerId)}`;
  const tokenResp = await fetch(tokenUrl);
  const tokenJson = await tokenResp.json();
  const ID_TOKEN = tokenJson.id_token;
  log('id_token obtained');

  // Inject SDK with vault=true and data-user-id-token
  const script = document.createElement('script');
  script.src = `https://www.paypal.com/sdk/js?client-id=${cfg.clientId}&vault=true&intent=capture&locale=ja_JP&currency=JPY`;
  script.setAttribute('data-user-id-token', ID_TOKEN);
  document.head.appendChild(script);

  script.onload = () => {
    log('PayPal SDK loaded');
    renderButtons();
  };

  // populate vaultId if customerId present
  async function checkVaultedPayments(){
    if (!customerId) return;
    try {
      const resp = await fetch(`/api/payment-tokens/${encodeURIComponent(customerId)}`);
      const json = await resp.json();
      if (json.payment_tokens && json.payment_tokens.length > 0){
        vaultId = json.payment_tokens[0].id;
        localStorage.setItem('paypal_vault_id', vaultId);
        log('Found vault token:', vaultId);
        renderSavedInfo();
      }
    } catch (e) {
      log('payment-tokens fetch error', e.message || e);
    }
  }
  await checkVaultedPayments();

  function renderButtons(){
    if (!window.paypal) { log('paypal not loaded'); return; }
    const capturedOrders = new Map(); // orderId -> capture

    async function callOneclickFromClient() {
      // Add a request id so server idempotency can use it (optional)
      const requestId = 'client-' + (Date.now()) + '-' + Math.random().toString(36).slice(2,8);
      const resp = await fetch('/api/orders/oneclick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Idempotency-Key': requestId },
        body: JSON.stringify({ vaultId, customerId, amount: '100', currency: 'JPY' })
      });
      const body = await resp.json();
      if (!resp.ok) throw body;
      return body;
    }

    paypal.Buttons({
      style: { layout: 'vertical', label: 'paypal' },
      vault: customerId ? { customer_id: customerId } : undefined,

      onClick: async (data, actions) => {
        try {
          if (vaultId) {
            log('onClick: vaultId present -> calling oneclick');
            let body;
            try {
              body = await callOneclickFromClient();
            } catch (errBody) {
              log('oneclick failed in onClick', JSON.stringify(errBody));
              await actions.reject();
              alert('æ±ºæ¸ˆå¤±æ•—: ' + (errBody.error || JSON.stringify(errBody)));
              return;
            }
            if (body.orderId) capturedOrders.set(body.orderId, body.capture || null);
            await actions.reject(); // prevents modal
            // persist returned data
            const cap = body.capture;
            const vaultInfo = cap?.payment_source?.paypal?.attributes?.vault;
            const payerInfo = cap?.payer;
            const paypalSource = cap?.payment_source?.paypal;
            if (vaultInfo?.id) { vaultId = vaultInfo.id; localStorage.setItem('paypal_vault_id', vaultId); }
            if (vaultInfo?.customer?.id) { customerId = vaultInfo.customer.id; localStorage.setItem('paypal_customer_id', customerId); }
            if (payerInfo?.payer_id) { payerId = payerInfo.payer_id; localStorage.setItem('paypal_payer_id', payerId); }
            if (paypalSource?.account_id) { accountId = paypalSource.account_id; localStorage.setItem('paypal_account_id', accountId); }
            renderSavedInfo();
            alert('æ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            return;
          }
          await actions.resolve();
        } catch (err) {
          console.error('onClick error', err);
          await actions.reject();
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      },

      createOrder: async () => {
        try {
          if (vaultId) {
            // If onClick already populated capturedOrders, return existing orderId
            for (const [orderId] of capturedOrders) return orderId;
            // else call oneclick here
            log('createOrder: vault present but not pre-captured. Calling oneclick from createOrder.');
            const body = await callOneclickFromClient();
            if (body.orderId) capturedOrders.set(body.orderId, body.capture || null);
            return body.orderId;
          }
          // initial flow
          const resp = await fetch('/api/orders', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ customerId })
          });
          const data = await resp.json();
          if (!resp.ok) throw data;
          return data.id;
        } catch (err) {
          console.error('createOrder error', err);
          throw err;
        }
      },

      onApprove: async (data) => {
        try {
          const orderId = data.orderID || data.orderId;
          log('onApprove for', orderId);
          if (capturedOrders.has(orderId)) {
            log('Order already captured; skipping capture:', orderId);
            return;
          }
          const resp = await fetch(`/api/orders/${orderId}/capture`, { method: 'POST' });
          const capture = await resp.json();
          if (!resp.ok) {
            if (capture && capture.name === 'UNPROCESSABLE_ENTITY') {
              const already = (capture.details || []).some(d => d.issue === 'ORDER_ALREADY_CAPTURED');
              if (already) { log('ORDER_ALREADY_CAPTURED treated as success'); capturedOrders.set(orderId, capture); return; }
            }
            throw new Error(capture.error || JSON.stringify(capture));
          }
          capturedOrders.set(orderId, capture);
        } catch (err) {
          console.error('onApprove error', err);
        }
      },

      onError: (err) => { console.error('PayPal Buttons error', err); }
    }).render('#paypal-button-container').then(()=> log('buttons rendered'));
  }

  document.getElementById('oneclickDirect').onclick = async () => {
    if (!vaultId) return alert('Vault IDãŒã‚ã‚Šã¾ã›ã‚“');
    try {
      log('oneclickDirect: calling oneclick');
      const resp = await fetch('/api/orders/oneclick', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ vaultId, customerId, amount:'100', currency:'JPY' })
      });
      const body = await resp.json();
      if (!resp.ok) throw body;
      log('oneclickDirect success', JSON.stringify(body));
      alert('æ±ºæ¸ˆå®Œäº†');
      // store returned info
      const cap = body.capture;
      const vaultInfo = cap?.payment_source?.paypal?.attributes?.vault;
      const payerInfo = cap?.payer;
      const paypalSource = cap?.payment_source?.paypal;
      if (vaultInfo?.id) { vaultId = vaultInfo.id; localStorage.setItem('paypal_vault_id', vaultId); }
      if (vaultInfo?.customer?.id) { customerId = vaultInfo.customer.id; localStorage.setItem('paypal_customer_id', customerId); }
      if (payerInfo?.payer_id) localStorage.setItem('paypal_payer_id', payerInfo.payer_id);
      if (paypalSource?.account_id) localStorage.setItem('paypal_account_id', paypalSource.account_id);
      renderSavedInfo();
    } catch (e) {
      console.error('oneclickDirect error', e);
      alert('oneclick failed: ' + (e.error || JSON.stringify(e)));
    }
  };

})();
</script>
</body>
</html>
