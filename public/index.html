<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayPal Vault Demo â€” Returning + One-click</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;background:#f6f8fb}
    .card{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
    input{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%}
    button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .primary{background:#0070ba;color:#fff}
    .muted{background:#eef2f6}
    pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;max-height:400px}
    .info{margin:12px 0;color:#333}
    code{background:#eef2f6;padding:2px 6px;border-radius:4px;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h1>PayPal Vault â€” Returning + One-click</h1>
    <p class="info">Vault IDãŒã‚ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚µãƒ¼ãƒãƒ¼å´ Createâ†’Capture ã‚’å®Œçµã•ã›ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã›ã‚“ã€‚</p>

    <div style="margin-bottom:12px">
      <button id="clearStorage" class="muted">LocalStorage ã‚¯ãƒªã‚¢</button>
    </div>

    <div style="margin-bottom:12px">
      <strong>ä¿å­˜æ¸ˆã¿æƒ…å ±ï¼ˆlocalStorageï¼‰</strong>
      <div id="savedInfo" style="margin-top:8px"></div>
    </div>

    <div id="paypal-button-container" style="margin-bottom:20px;min-height:120px"></div>

    <div style="margin-top:12px">
      <button id="oneclickDirect" class="primary">ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ±ºæ¸ˆï¼ˆVaultãŒã‚ã‚‹å ´åˆï¼‰</button>
    </div>

    <h3 style="margin-top:20px">ãƒ­ã‚° / çµæœ</h3>
    <pre id="log">æº–å‚™ä¸­...</pre>
  </div>

<script>
(async function(){
  const logEl = document.getElementById('log');
  function log(...args){
    logEl.textContent = new Date().toLocaleTimeString() + ' ' + args.join(' ') + '\n' + logEl.textContent;
  }

  let customerId = localStorage.getItem('paypal_customer_id') || null;
  let vaultId    = localStorage.getItem('paypal_vault_id')    || null;
  let payerId    = localStorage.getItem('paypal_payer_id')    || null;
  let accountId  = localStorage.getItem('paypal_account_id') || null;

  function renderSavedInfo(){
    const el = document.getElementById('savedInfo');
    el.innerHTML = '';
    if (vaultId)    el.innerHTML += `<div>ğŸ” vaultId: <code>${vaultId}</code></div>`;
    if (customerId) el.innerHTML += `<div>ğŸ‘¤ customerId: <code>${customerId}</code></div>`;
    if (payerId)    el.innerHTML += `<div>payerId: <code>${payerId}</code></div>`;
    if (accountId)  el.innerHTML += `<div>accountId: <code>${accountId}</code></div>`;
    if (!vaultId && !customerId) el.innerHTML = '<div>ä¿å­˜ãªã—</div>';
  }
  renderSavedInfo();

  // Vaultãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function saveVaultInfo(capture) {
    const vaultInfo    = capture?.payment_source?.paypal?.attributes?.vault;
    const payerInfo    = capture?.payer;
    const paypalSource = capture?.payment_source?.paypal;
    if (vaultInfo?.id)          { vaultId    = vaultInfo.id;              localStorage.setItem('paypal_vault_id', vaultId); }
    if (vaultInfo?.customer?.id){ customerId  = vaultInfo.customer.id;    localStorage.setItem('paypal_customer_id', customerId); }
    if (payerInfo?.payer_id)    { payerId     = payerInfo.payer_id;       localStorage.setItem('paypal_payer_id', payerId); }
    if (paypalSource?.account_id){ accountId  = paypalSource.account_id; localStorage.setItem('paypal_account_id', accountId); }
    renderSavedInfo();
  }

  document.getElementById('clearStorage').onclick = () => {
    localStorage.clear();
    customerId = vaultId = payerId = accountId = null;
    renderSavedInfo();
    log('LocalStorage cleared');
  };

  // --- SDK èª­ã¿è¾¼ã¿ ---
  const cfgResp = await fetch('/api/config');
  const cfg = await cfgResp.json();

  let tokenUrl = '/api/generate-client-token';
  if (customerId) tokenUrl += `?customer_id=${encodeURIComponent(customerId)}`;
  const tokenJson = await (await fetch(tokenUrl)).json();
  log('id_token obtained');

  // Payment Tokensç¢ºèª
  if (customerId) {
    try {
      const pt = await (await fetch(`/api/payment-tokens/${encodeURIComponent(customerId)}`)).json();
      if (pt.payment_tokens?.length > 0) {
        vaultId = pt.payment_tokens[0].id;
        localStorage.setItem('paypal_vault_id', vaultId);
        log('Found vault token:', vaultId);
        renderSavedInfo();
      }
    } catch(e) { log('payment-tokens error:', e.message); }
  }

  await new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = `https://www.paypal.com/sdk/js?client-id=${cfg.clientId}&vault=true&intent=capture&locale=ja_JP&currency=JPY`;
    script.setAttribute('data-user-id-token', tokenJson.id_token);
    script.onload  = () => { log('PayPal SDK loaded'); resolve(); };
    script.onerror = reject;
    document.head.appendChild(script);
  });

  // --- PayPal ãƒœã‚¿ãƒ³æç”» ---

  // Vault oneclickå‡¦ç†ã®å®Œäº†ãƒ•ãƒ©ã‚°
  // onClick ã§æ±ºæ¸ˆãŒå®Œçµã—ãŸå ´åˆ true ã«ã™ã‚‹ã“ã¨ã§
  // createOrder / onApprove / onError ã®å¾Œç¶šå‡¦ç†ã‚’ã™ã¹ã¦ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
  let oneclickDone = false;

  paypal.Buttons({
    style: { layout: 'vertical', label: 'paypal' },
    vault: customerId ? { customer_id: customerId } : undefined,

    // ===== onClick =====
    // vaultId ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§æ±ºæ¸ˆã‚’å®Œçµã•ã› actions.reject() ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒ–ãƒ­ãƒƒã‚¯
    onClick: async (data, actions) => {
      if (!vaultId) {
        // åˆå›ï¼šé€šå¸¸ãƒ•ãƒ­ãƒ¼ã«é€²ã‚€
        return actions.resolve();
      }

      log('onClick: vaultId ã‚ã‚Š â†’ oneclick æ±ºæ¸ˆé–‹å§‹');
      try {
        const resp = await fetch('/api/orders/oneclick', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vaultId, customerId, amount: '100', currency: 'JPY' })
        });
        const body = await resp.json();

        if (!resp.ok) {
          log('oneclick å¤±æ•—:', JSON.stringify(body));
          // å¤±æ•—ã—ã¦ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯å‡ºã•ãªã„ï¼ˆonError ãŒå‡ºãªã„ã‚ˆã† reject å‰ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ãªã„ï¼‰
          alert('æ±ºæ¸ˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (body.error || JSON.stringify(body)));
          return actions.reject();
        }

        log('oneclick æˆåŠŸ orderId:', body.orderId, '| capture status:', body.capture?.status);
        saveVaultInfo(body.capture);

        // âœ… æ±ºæ¸ˆå®Œäº†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦ã‹ã‚‰ reject
        // â†’ createOrder / onApprove / onError ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
        oneclickDone = true;
        await actions.reject();

        alert('æ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸ');

      } catch(err) {
        log('onClick error:', err.message);
        alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
        await actions.reject();
      }
    },

    // ===== createOrder =====
    // onClick ã§ oneclick ãŒå®Œçµã—ãŸå ´åˆã¯å‘¼ã°ã‚Œã¦ã‚‚ä½•ã‚‚ã—ãªã„ï¼ˆSDKãŒå†…éƒ¨ã§callã™ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ï¼‰
    createOrder: async () => {
      if (oneclickDone) {
        // oneclickDone=true ã®ã¨ãã¯ã“ã“ã«æ¥ã¦ã‚‚ abort ã•ã›ã‚‹
        log('createOrder: oneclick å®Œäº†æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        throw new Error('ONECLICK_DONE');
      }

      // åˆå›é€šå¸¸ãƒ•ãƒ­ãƒ¼
      log('createOrder: åˆå›ãƒ•ãƒ­ãƒ¼ â†’ /api/orders');
      const resp = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId })
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || JSON.stringify(data));
      log('order created:', data.id);
      return data.id;
    },

    // ===== onApprove =====
    // åˆå›ãƒ•ãƒ­ãƒ¼å°‚ç”¨ã€‚oneclick å®Œäº†å¾Œã¯å‘¼ã°ã‚Œãªã„ï¼ˆcreateOrder ãŒ throw ã™ã‚‹ãŸã‚ï¼‰
    onApprove: async (data) => {
      if (oneclickDone) {
        log('onApprove: oneclick å®Œäº†æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      log('onApprove: capture é–‹å§‹ orderId:', data.orderID);
      const resp    = await fetch(`/api/orders/${data.orderID}/capture`, { method: 'POST' });
      const capture = await resp.json();
      if (!resp.ok) throw new Error(capture.error || JSON.stringify(capture));

      log('capture æˆåŠŸ:', capture.status);
      saveVaultInfo(capture);
    },

    // ===== onError =====
    // oneclickDone ã®å ´åˆã¯ actions.reject() ã«ã‚ˆã‚‹æ„å›³çš„ãªã‚¨ãƒ©ãƒ¼ãªã®ã§ç„¡è¦–
    onError: (err) => {
      if (oneclickDone) {
        log('onError: oneclick å®Œäº†å¾Œã®æƒ³å®šå†…ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰');
        return;
      }
      log('PayPal Buttons error:', err?.message || JSON.stringify(err));
    }

  }).render('#paypal-button-container')
    .then(() => log('PayPal buttons rendered'));

  // --- ç›´æ¥ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒœã‚¿ãƒ³ ---
  document.getElementById('oneclickDirect').onclick = async () => {
    if (!vaultId) {
      alert('Vault IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšåˆå›è³¼å…¥ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    log('ç›´æ¥ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œ');
    try {
      const resp = await fetch('/api/orders/oneclick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vaultId, customerId, amount: '100', currency: 'JPY' })
      });
      const data = await resp.json();
      if (!resp.ok) {
        log('oneclick direct å¤±æ•—:', JSON.stringify(data));
        alert('Failed: ' + (data.error || JSON.stringify(data)));
        return;
      }
      log('oneclick direct æˆåŠŸ:', JSON.stringify(data));
      saveVaultInfo(data.capture);
      alert('æ±ºæ¸ˆå®Œäº†');
    } catch(e) {
      log('oneclick direct error:', e.message);
      alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  };

})();
</script>
</body>
</html>
