<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayPal Vault Demo â€” Returning + One-click</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;background:#f6f8fb}
    .card{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px}
    input{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%}
    button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .primary{background:#0070ba;color:#fff}
    .muted{background:#eef2f6}
    pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
    .info{margin:12px 0;color:#333}
  </style>
</head>
<body>
  <div class="card">
    <h1>PayPal Vault â€” Returning + One-click</h1>
    <p class="info">ä¿å­˜æ¸ˆã¿ï¼ˆVaultï¼‰ã‚’ãƒœã‚¿ãƒ³ã«è¡¨ç¤ºã—ã¤ã¤ã€Vault IDãŒã‚ã‚Œã°ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§ã‚µãƒ¼ãƒå´ Createâ†’Capture ã‚’èµ°ã‚‰ã›ã¦ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ±ºæ¸ˆã‚’å®Œäº†ã—ã¾ã™ã€‚</p>

    <div style="margin-bottom:12px">
      <button id="clearStorage" class="muted">LocalStorage ã‚¯ãƒªã‚¢</button>
    </div>

    <div style="margin-bottom:12px">
      <strong>ä¿å­˜æ¸ˆã¿æƒ…å ±ï¼ˆlocalStorageï¼‰</strong>
      <div id="savedInfo" style="margin-top:8px"></div>
    </div>

    <div id="paypal-button-container" style="margin-bottom:20px; min-height:120px"></div>

    <div style="margin-top:12px">
      <button id="oneclickDirect" class="primary">ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ±ºæ¸ˆï¼ˆVaultãŒã‚ã‚‹å ´åˆï¼‰</button>
    </div>

    <h3 style="margin-top:20px">ãƒ­ã‚° / çµæœ</h3>
    <pre id="log">æº–å‚™ä¸­...</pre>
  </div>

<script>
(async function(){
  const logEl = document.getElementById('log');
  function log(...args){ logEl.textContent = (new Date()).toLocaleTimeString() + ' ' + args.join(' ') + '\n' + logEl.textContent; }

  // load saved
  let customerId = localStorage.getItem('paypal_customer_id') || null;
  let vaultId = localStorage.getItem('paypal_vault_id') || null;
  let payerId = localStorage.getItem('paypal_payer_id') || null;
  let accountId = localStorage.getItem('paypal_account_id') || null;

  function renderSavedInfo(){
    const cont = document.getElementById('savedInfo');
    cont.innerHTML = '';
    if (vaultId) cont.innerHTML += `<div>ğŸ” vaultId: <code>${vaultId}</code></div>`;
    if (customerId) cont.innerHTML += `<div>ğŸ‘¤ customerId: <code>${customerId}</code></div>`;
    if (payerId) cont.innerHTML += `<div>payerId: <code>${payerId}</code></div>`;
    if (accountId) cont.innerHTML += `<div>accountId: <code>${accountId}</code></div>`;
    if (!vaultId && !customerId) cont.innerHTML = '<div>ä¿å­˜ãªã—</div>';
  }
  renderSavedInfo();

  document.getElementById('clearStorage').onclick = () => {
    localStorage.clear();
    customerId = vaultId = payerId = accountId = null;
    renderSavedInfo();
    log('LocalStorage cleared');
  };

  // 1) get config
  const cfgResp = await fetch('/api/config');
  const cfg = await cfgResp.json();
  const CLIENT_ID = cfg.clientId;

  // 2) If customerId present, request id_token with target_customer_id
  let tokenUrl = '/api/generate-client-token';
  if (customerId) tokenUrl += `?customer_id=${encodeURIComponent(customerId)}`;

  const tokenResp = await fetch(tokenUrl);
  const tokenJson = await tokenResp.json();
  const ID_TOKEN = tokenJson.id_token;
  log('id_token obtained');

  // 3) Load PayPal SDK with vault=true and data-user-id-token
  const script = document.createElement('script');
  script.src = `https://www.paypal.com/sdk/js?client-id=${CLIENT_ID}&vault=true&intent=capture&locale=ja_JP&currency=JPY`;
  script.setAttribute('data-user-id-token', ID_TOKEN);
  document.head.appendChild(script);

  script.onload = () => {
    log('PayPal SDK loaded');
    renderButtons();
  };

  script.onerror = (e) => {
    log('PayPal SDK load error', e.message || e);
  };

  // Check vaulted payment tokens (populate vaultId if available)
  async function checkVaultedPayments(){
    if (!customerId) return;
    try {
      const resp = await fetch(`/api/payment-tokens/${encodeURIComponent(customerId)}`);
      const json = await resp.json();
      if (json.payment_tokens && json.payment_tokens.length > 0){
        vaultId = json.payment_tokens[0].id;
        localStorage.setItem('paypal_vault_id', vaultId);
        log('Found vault token:', vaultId);
        renderSavedInfo();
      } else {
        log('No payment_tokens for customer');
      }
    } catch (e) {
      log('Error fetching payment tokens', e.message || e);
    }
  }

  await checkVaultedPayments();

  // Render PayPal Buttons
  function renderButtons(){
    if (!window.paypal) {
      log('paypal SDK not ready');
      return;
    }

    // update UI title based on vault existence
    if (vaultId) {
      const desc = document.createElement('div');
      desc.innerHTML = '<strong>âš¡ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰ã§æ”¯æ‰•ã„ã¾ã™</strong>';
      document.getElementById('paypal-button-container').appendChild(desc);
    }

    paypal.Buttons({
      style: { layout: 'vertical', label: 'paypal' },

      // Give SDK the customer_id so it displays saved payment methods
      vault: customerId ? { customer_id: customerId } : undefined,

      createOrder: async () => {
        // If vaultId exists, call oneclick endpoint (server does create+capture)
        if (vaultId) {
          log('createOrder -> calling /api/orders/oneclick (vaultId present)');
          const resp = await fetch('/api/orders/oneclick', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ vaultId, customerId, amount: '100', currency: 'JPY' })
          });
          const data = await resp.json();
          if (!resp.ok) {
            log('oneclick error', JSON.stringify(data));
            throw new Error(data.error || JSON.stringify(data));
          }
          // We return the orderId (already captured). SDK may or may not call onApprove.
          log('oneclick success, order:', data.orderId);
          return data.orderId;
        } else {
          // Normal flow: create order via /api/orders
          log('createOrder -> calling /api/orders (new flow)');
          const resp = await fetch('/api/orders', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ customerId })
          });
          const data = await resp.json();
          if (!resp.ok) {
            log('create order error', JSON.stringify(data));
            throw new Error(data.error || JSON.stringify(data));
          }
          log('order created (initial):', data.id);
          return data.id;
        }
      },

      onApprove: async (data) => {
        log('onApprove called', JSON.stringify(data));
        // If server already captured in oneclick, you may skip capture here.
        // But to be safe in mixed flows, call capture endpoint if order not captured.
        try {
          const resp = await fetch(`/api/orders/${data.orderID}/capture`, { method: 'POST' });
          const capture = await resp.json();
          if (!resp.ok) {
            log('capture failed in onApprove', JSON.stringify(capture));
            throw new Error(capture.error || JSON.stringify(capture));
          }
          log('capture succeeded:', JSON.stringify(capture));
          // Save vault/customer/payer/account info if present
          const vaultInfo = capture.payment_source?.paypal?.attributes?.vault;
          const payerInfo = capture.payer;
          const paypalSource = capture.payment_source?.paypal;
          if (vaultInfo?.id) {
            vaultId = vaultInfo.id;
            localStorage.setItem('paypal_vault_id', vaultId);
          }
          if (vaultInfo?.customer?.id) {
            customerId = vaultInfo.customer.id;
            localStorage.setItem('paypal_customer_id', customerId);
          }
          if (payerInfo?.payer_id) {
            payerId = payerInfo.payer_id;
            localStorage.setItem('paypal_payer_id', payerId);
          }
          if (paypalSource?.account_id) {
            accountId = paypalSource.account_id;
            localStorage.setItem('paypal_account_id', accountId);
          }
          renderSavedInfo();
        } catch (e) {
          log('onApprove capture error', e.message || e);
        }
      },

      onError: (err) => {
        log('PayPal Buttons error', err && (err.toString ? err.toString() : JSON.stringify(err)));
      }
    }).render('#paypal-button-container').then(()=> log('PayPal buttons rendered'));
  }

  // Button: direct oneclick (same as clicking PayPal button when vault exists)
  document.getElementById('oneclickDirect').onclick = async () => {
    if (!vaultId) return alert('Vault IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšVaultã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼ˆåˆå›è³¼å…¥ï¼‰ã€‚');
    log('ç›´æ¥ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œ: calling /api/orders/oneclick');
    try {
      const resp = await fetch('/api/orders/oneclick', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ vaultId, customerId, amount: '100', currency: 'JPY' })
      });
      const data = await resp.json();
      if (!resp.ok) {
        log('oneclick direct failed', JSON.stringify(data));
        alert('Failed: ' + (data.error || JSON.stringify(data)));
        return;
      }
      log('oneclick direct success: ' + JSON.stringify(data));
      // update saved info if capture returned vault/customer
      const cap = data.capture;
      const vaultInfo = cap?.payment_source?.paypal?.attributes?.vault;
      const payerInfo = cap?.payer;
      if (vaultInfo?.id) {
        vaultId = vaultInfo.id;
        localStorage.setItem('paypal_vault_id', vaultId);
      }
      if (vaultInfo?.customer?.id) {
        customerId = vaultInfo.customer.id;
        localStorage.setItem('paypal_customer_id', customerId);
      }
      if (payerInfo?.payer_id) {
        payerId = payerInfo.payer_id;
        localStorage.setItem('paypal_payer_id', payerId);
      }
      renderSavedInfo();
      alert('æ±ºæ¸ˆå®Œäº†');
    } catch (e) {
      log('oneclick direct error', e.message || e);
      alert('ã‚¨ãƒ©ãƒ¼: ' + (e.message || e));
    }
  };

})();
</script>
</body>
</html>
