<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayPal Vault - Shipping Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 24px;
    }
    .container { max-width: 720px; margin: 0 auto; }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,.08);
    }
    h1 { margin-bottom: 6px; }
    h2 { font-size: 16px; margin-bottom: 14px; color: #333; }
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 6px;
    }
    .mode-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .mode-card:hover { border-color: #667eea; background: #f8f7ff; }
    .mode-card.selected { border-color: #667eea; background: #f0eeff; }
    .mode-card .icon { font-size: 24px; margin-bottom: 6px; }
    .mode-card .title { font-weight: bold; font-size: 13px; margin-bottom: 4px; }
    .mode-card .desc { font-size: 11px; color: #666; line-height: 1.4; }
    .mode-card .tag {
      display: inline-block;
      margin-top: 6px;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
    }
    .tag-green  { background: #e8f5e9; color: #2e7d32; }
    .tag-red    { background: #fce4ec; color: #c62828; }
    .tag-yellow { background: #fff8e1; color: #f57f17; }
    .result-box {
      margin-top: 10px;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
    }
    .result-oneclick  { background: #e8f5e9; color: #2e7d32; }
    .result-modal     { background: #fff8e1; color: #f57f17; }
    .result-pending   { background: #f5f7fa; color: #888; }
    .info-box {
      background: #f5f7fa;
      border-left: 4px solid #667eea;
      border-radius: 6px;
      padding: 12px 14px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .info-box .label { font-weight: bold; color: #444; margin-bottom: 4px; }
    .info-box .value { font-family: monospace; color: #555; word-break: break-all; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
    .alert-success { background: #d4edda; color: #155724; }
    .alert-info    { background: #d1ecf1; color: #0c5460; }
    .alert-danger  { background: #f8d7da; color: #721c24; }
    .debug-log {
      background: #0b1220;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 320px;
      overflow-y: auto;
      line-height: 1.7;
    }
    .debug-log .ts      { color: #608b4e; }
    .debug-log .success { color: #4ec9b0; }
    .debug-log .error   { color: #f48771; }
    .debug-log .info    { color: #9cdcfe; }
    .debug-log .vault   { color: #dcdcaa; font-weight: bold; }
    #paypal-button-container { min-height: 50px; }
    .clear-btn {
      display: block;
      margin: 8px auto 0;
      padding: 10px 28px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .clear-btn:hover { background: #c62828; }
    pre {
      background: #f5f7fa;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    code { background: #eef2f6; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
  </style>
</head>
<body>
<div class="container">

  <div class="card">
    <h1>ğŸ’³ PayPal Vault - Shipping Test</h1>
    <p style="color:#666;font-size:14px;margin-top:6px">
      ä½æ‰€è¨­å®šã¨ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ»Seller Protectionã®é–¢ä¿‚ã‚’æ¤œè¨¼ã—ã¾ã™
    </p>
  </div>

  <!-- ä¿å­˜æ¸ˆã¿æƒ…å ± -->
  <div id="saved-section" style="display:none">
    <div class="card">
      <h2>ğŸ‘¤ ä¿å­˜æ¸ˆã¿Vaultæƒ…å ±</h2>
      <div id="saved-content"></div>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
  <div class="card">
    <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
    <div class="mode-grid" style="grid-template-columns: repeat(2, 1fr)">

      <div class="mode-card selected" data-mode="no_shipping" onclick="selectMode('no_shipping', this)">
        <div class="icon">ğŸš«</div>
        <div class="title">ä½æ‰€ãªã—</div>
        <div class="desc"><code>NO_SHIPPING</code><br>ä½æ‰€ã‚’æ¸¡ã•ãªã„</div>
      </div>

      <div class="mode-card" data-mode="set_provided" onclick="selectMode('set_provided', this)">
        <div class="icon">ğŸ“¦</div>
        <div class="title">ä½æ‰€ã‚ã‚Š</div>
        <div class="desc"><code>SET_PROVIDED_ADDRESS</code><br>ä½æ‰€ã‚’æ¸¡ã™</div>
      </div>

    </div>

    <!-- åˆ¤å®šçµæœ -->
    <div id="mode-result" class="result-box result-pending">
      ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
    </div>
  </div>

  <!-- ãƒ­ã‚° -->
  <div class="card">
    <h2>ğŸ“‹ ãƒ­ã‚°</h2>
    <div class="debug-log" id="log-area"><span class="info">åˆæœŸåŒ–ä¸­...</span></div>
  </div>

  <div id="status"></div>

  <!-- PayPal ãƒœã‚¿ãƒ³ -->
  <div class="card">
    <h2 id="btn-title">PayPalã§æ”¯æ‰•ã†</h2>
    <p id="btn-desc" style="font-size:13px;color:#666;margin-bottom:14px"></p>
    <div id="paypal-button-container"></div>
  </div>

  <div id="result-section" style="display:none">
    <div class="card">
      <h2>ğŸ“„ Captureãƒ¬ã‚¹ãƒãƒ³ã‚¹</h2>
      <pre id="result-json"></pre>
    </div>
  </div>

  <button class="clear-btn" onclick="clearData()">ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>

</div>
<script>
(async () => {

  let customerId = localStorage.getItem('paypal_customer_id') || null;
  let vaultId    = localStorage.getItem('paypal_vault_id')    || null;
  let shippingMode = 'no_shipping'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

  // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šãƒ•ãƒ©ã‚°ï¼ˆonApprove ãŒå‘¼ã°ã‚Œã‚‹å‰ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ãŸã‹ã©ã†ã‹ï¼‰
  let popupOpened = false;

  function log(msg, type = 'info') {
    const el = document.getElementById('log-area');
    const ts = new Date().toLocaleTimeString('ja-JP', {
      hour:'2-digit', minute:'2-digit', second:'2-digit', fractionalSecondDigits:2
    });
    const div = document.createElement('div');
    div.innerHTML = `<span class="ts">[${ts}]</span> <span class="${type}">${msg}</span>`;
    el.insertBefore(div, el.firstChild);
  }

  function renderSaved() {
    if (!customerId && !vaultId) return;
    document.getElementById('saved-section').style.display = 'block';
    let html = '';
    if (vaultId) {
      html += `<div class="info-box" style="border-left-color:#0070ba">
        <div class="label">ğŸ” Vault ID</div>
        <div class="value">${vaultId}</div>
      </div>`;
    }
    if (customerId) {
      html += `<div class="info-box">
        <div class="label">Customer ID</div>
        <div class="value">${customerId}</div>
      </div>`;
    }
    document.getElementById('saved-content').innerHTML = html;
  }

  function updateButtonArea() {
    if (customerId) {
      document.getElementById('btn-title').textContent = 'ğŸ”„ PayPalã§æ”¯æ‰•ã†ï¼ˆReturning Payerï¼‰';
      document.getElementById('btn-desc').textContent = 'ä¿å­˜æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®æ±ºæ¸ˆãƒ†ã‚¹ãƒˆã§ã™ã€‚';
    } else {
      document.getElementById('btn-title').textContent = 'ğŸ†• PayPalã§æ”¯æ‰•ã†ï¼ˆåˆå›ï¼‰';
      document.getElementById('btn-desc').textContent = 'åˆå›è³¼å…¥ã§Vaultã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
    }
  }

  function showStatus(msg, type = 'info') {
    document.getElementById('status').innerHTML =
      `<div class="alert alert-${type}">${msg}</div>`;
  }

  // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
  window.selectMode = (mode, el) => {
    shippingMode = mode;
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');

    const modeLabels = {
      no_shipping:  'ä½æ‰€ãªã—ãƒ»NO_SHIPPING',
      none:         'ä½æ‰€ã‚ã‚Šãƒ»NO_SHIPPING',
      set_provided: 'ä½æ‰€ã‚ã‚Šãƒ»SET_PROVIDED_ADDRESS'
    };
    log(`ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å¤‰æ›´: ${modeLabels[mode]}`, 'vault');

    // åˆ¤å®šãƒªã‚»ãƒƒãƒˆ
    const r = document.getElementById('mode-result');
    r.className = 'result-box result-pending';
    r.textContent = 'ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
  };

  // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šçµæœã‚’è¡¨ç¤º
  function showClickResult(wasOneClick) {
    const r = document.getElementById('mode-result');
    if (wasOneClick) {
      r.className = 'result-box result-oneclick';
      r.textContent = 'âœ… ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æˆåŠŸ â€” ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ã§æ±ºæ¸ˆå®Œäº†';
    } else {
      r.className = 'result-box result-modal';
      r.textContent = 'âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ â€” ãƒ¢ãƒ¼ãƒ€ãƒ« / ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ';
    }
  }

  // Payment Tokens ç¢ºèª
  async function checkPaymentTokens() {
    if (!customerId) return;
    try {
      log('Payment Tokens ç¢ºèªä¸­...');
      const resp = await fetch(`/api/payment-tokens/${encodeURIComponent(customerId)}`);
      const data = await resp.json();
      if (data.payment_tokens?.length > 0) {
        vaultId = data.payment_tokens[0].id;
        localStorage.setItem('paypal_vault_id', vaultId);
        log(`âœ“ Vaultæ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª: ${vaultId}`, 'vault');
        renderSaved();
      }
    } catch (e) {
      log(`Payment Tokens ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
    }
  }

  // SDK èª­ã¿è¾¼ã¿
  async function loadSDK() {
    const cfg = await (await fetch('/api/config')).json();
    const tokenUrl = customerId
      ? `/api/generate-client-token?customer_id=${encodeURIComponent(customerId)}`
      : '/api/generate-client-token';
    const { id_token } = await (await fetch(tokenUrl)).json();
    log(customerId ? 'Returning Payer ç”¨ id_token å–å¾—' : 'æ–°è¦ Payer ç”¨ id_token å–å¾—', 'vault');

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      // Returning Payer ã«ã¯ vault=true ã‚’ä»˜ã‘ãªã„ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ¡ä»¶ï¼‰
      const vaultParam = customerId ? '' : '&vault=true';
      script.src = `https://www.paypal.com/sdk/js?client-id=${cfg.clientId}&intent=capture${vaultParam}&locale=ja_JP&currency=JPY`;
      script.setAttribute('data-user-id-token', id_token);
      script.onload  = () => { log('âœ“ PayPal SDK èª­ã¿è¾¼ã¿å®Œäº†', 'success'); resolve(); };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // PayPal ãƒœã‚¿ãƒ³åˆæœŸåŒ–
  function initButtons() {
    paypal.Buttons({
      style: { layout: 'vertical', label: 'paypal' },
      vault: customerId ? { customer_id: customerId } : undefined,

      onClick: async (data, actions) => {
        // onClick ãŒå‘¼ã°ã‚ŒãŸæ™‚ç‚¹ã§ã¯ã¾ã ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ãªã„
        // ã“ã“ã§ popupOpened ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        popupOpened = false;
        log(`onClick: shippingMode=${shippingMode}`, 'info');
        return actions.resolve();
      },

      createOrder: async () => {
        log(`Order ä½œæˆä¸­... (shippingMode=${shippingMode})`);
        showStatus('æ³¨æ–‡ã‚’ä½œæˆä¸­...');
        const resp = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerId, shippingMode })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || JSON.stringify(data));
        log(`âœ“ Order ä½œæˆ: ${data.id}`, 'success');

        // createOrder ãŒè¿”ã£ãŸç›´å¾Œã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ãã‹ã©ã†ã‹ã‚’
        // å°‘ã—é…å»¶ã—ã¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ï¼ˆSDK ã®æŒ™å‹•ã‚’è¦³å¯Ÿï¼‰
        setTimeout(() => {
          // window.opener ã‚„ iframe ã®å­˜åœ¨ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¤œçŸ¥ã¯é›£ã—ã„ãŸã‚
          // onApprove ãŒå‘¼ã°ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åˆ¤å®šã™ã‚‹
        }, 100);

        return data.id;
      },

      // onApprove ã¯ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸¡æ–¹ã§å‘¼ã°ã‚Œã‚‹
      // data.isPopup ãªã©ã®åˆ¤å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ SDK ãŒæä¾›ã—ã¦ã„ãªã„ãŸã‚
      // createOrder â†’ onApprove ã®é–“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒã‚ã£ãŸã‹ã‚’ãƒ­ã‚°ã§è¦³å¯Ÿã™ã‚‹
      onApprove: async (data) => {
        log('âœ“ onApprove å‘¼ã³å‡ºã—ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ or ãƒ¢ãƒ¼ãƒ€ãƒ«æ‰¿èªå¾Œï¼‰', 'success');
        log(`orderID: ${data.orderID}`, 'info');
        showStatus('æ±ºæ¸ˆå‡¦ç†ä¸­...');

        const resp    = await fetch(`/api/orders/${data.orderID}/capture`, { method: 'POST' });
        const capture = await resp.json();
        if (!resp.ok) throw new Error(capture.error || JSON.stringify(capture));

        log('âœ“ Capture å®Œäº†', 'success');

        // Seller Protection ç¢ºèª
        const captures = capture.purchase_units?.[0]?.payments?.captures?.[0];
        const sellerProtection = captures?.seller_protection;
        log('='.repeat(40), 'vault');
        log(`Seller Protection Status: ${sellerProtection?.status || 'N/A'}`, 'vault');
        if (sellerProtection?.dispute_categories) {
          log(`Dispute Categories: ${sellerProtection.dispute_categories.join(', ')}`, 'vault');
        }
        log('='.repeat(40), 'vault');

        // Vault æƒ…å ±ä¿å­˜
        const vaultInfo    = capture.payment_source?.paypal?.attributes?.vault;
        const paypalSource = capture.payment_source?.paypal;
        if (vaultInfo?.id) {
          vaultId = vaultInfo.id;
          localStorage.setItem('paypal_vault_id', vaultId);
          log(`Vault ID: ${vaultInfo.id}`, 'vault');
        }
        if (vaultInfo?.customer?.id) {
          customerId = vaultInfo.customer.id;
          localStorage.setItem('paypal_customer_id', customerId);
        }
        if (paypalSource?.email_address) {
          log(`Email: ${paypalSource.email_address}`, 'info');
        }

        renderSaved();
        showStatus('âœ… æ±ºæ¸ˆå®Œäº†ï¼', 'success');
        document.getElementById('result-section').style.display = 'block';
        document.getElementById('result-json').textContent = JSON.stringify(capture, null, 2);

        // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã¯ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã¨ç…§åˆã—ã¦æ‰‹å‹•ç¢ºèª
        // ï¼ˆSDK ã¯ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯/ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åŒºåˆ¥ã‚’ onApprove ã§é€šçŸ¥ã—ãªã„ï¼‰
        log('âš ï¸ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®æŒ™å‹•ã¨ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ç¢ºèªã—ã¦ãã ã•ã„', 'info');

        setTimeout(() => location.reload(), 4000);
      },

      onCancel: () => {
        log('æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        showStatus('æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        showClickResult(false); // ã‚­ãƒ£ãƒ³ã‚»ãƒ« = ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ãŸ
      },

      onError: (err) => {
        log(`ã‚¨ãƒ©ãƒ¼: ${err?.message || JSON.stringify(err)}`, 'error');
        showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
      }

    }).render('#paypal-button-container')
      .then(() => {
        log('âœ“ PayPal ãƒœã‚¿ãƒ³è¡¨ç¤ºå®Œäº†', 'success');
        if (customerId) log('GetSmartWallet å‘¼ã³å‡ºã—ä¸­... ãƒœã‚¿ãƒ³ã«ä¿å­˜æ¸ˆã¿æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ', 'vault');
      });
  }

  function clearData() {
    if (!confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
    localStorage.clear();
    location.reload();
  }

  // åˆæœŸåŒ–
  log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
  if (customerId || vaultId) {
    log('--- ä¿å­˜æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º ---', 'vault');
    if (customerId) log(`Customer ID: ${customerId}`, 'vault');
    if (vaultId)    log(`Vault ID: ${vaultId}`, 'vault');
    renderSaved();
  }

  await checkPaymentTokens();
  updateButtonArea();

  try {
    await loadSDK();
    initButtons();
  } catch (e) {
    log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
    showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + e.message, 'danger');
  }

})();
</script>
</body>
</html>
